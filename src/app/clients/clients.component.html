<div class="clients-container">
  <div class="header">
    <h1>Gestion des Clients</h1>
    <button class="btn-primary" (click)="showAddForm = !showAddForm">
      <i class="icon-plus"></i>
      {{ showAddForm ? 'Annuler' : 'Nouveau Client' }}
    </button>
  </div>

  <!-- Formulaire d'ajout -->
  <div class="form-container" [class.show]="showAddForm">
    <div class="form-card">
      <div class="form-header">
        <h2>Ajouter un nouveau client</h2>
        <span class="form-subtitle">Remplissez les informations ci-dessous</span>
      </div>
      
      <form [formGroup]="clientForm" (ngSubmit)="addClient()" class="client-form">
        <div class="form-grid">
          <!-- Informations entreprise -->
          <div class="form-section">
            <h3 class="section-title">
              <i class="icon-building"></i>
              Informations de l'entreprise
            </h3>
            
            <div class="form-row">
              <div class="form-group">
                <label for="nomEntreprise">Nom de l'entreprise *</label>
                <input 
                  id="nomEntreprise"
                  type="text" 
                  formControlName="nomEntreprise"
                  placeholder="Ex: Dupont SARL"
                  [class.error]="clientForm.get('nomEntreprise')?.invalid && clientForm.get('nomEntreprise')?.touched"
                >
                <span class="error-message" *ngIf="clientForm.get('nomEntreprise')?.invalid && clientForm.get('nomEntreprise')?.touched">
                  Le nom de l'entreprise est requis
                </span>
              </div>
              
              <div class="form-group">
                <label for="secteurActivite">Secteur d'activité *</label>
                <select 
                  id="secteurActivite"
                  formControlName="secteurActivite"
                  [class.error]="clientForm.get('secteurActivite')?.invalid && clientForm.get('secteurActivite')?.touched"
                >
                  <option value="">Sélectionner un secteur</option>
                  <option value="Automobile">Automobile</option>
                  <option value="Chimie">Chimie</option>
                  <option value="Construction">Construction</option>
                  <option value="Informatique">Informatique</option>
                  <option value="Commerce">Commerce</option>
                  <option value="Santé">Santé</option>
                  <option value="Éducation">Éducation</option>
                  <option value="Finance">Finance</option>
                </select>
              </div>
            </div>

            <div class="form-group">
              <label for="siret">SIRET *</label>
              <input 
                id="siret"
                type="text" 
                formControlName="siret"
                placeholder="14 chiffres"
                maxlength="14"
                [class.error]="clientForm.get('siret')?.invalid && clientForm.get('siret')?.touched"
              >
              <span class="error-message" *ngIf="clientForm.get('siret')?.invalid && clientForm.get('siret')?.touched">
                Le SIRET doit contenir exactement 14 chiffres
              </span>
            </div>
          </div>

          <!-- Adresse -->
          <div class="form-section">
            <h3 class="section-title">
              <i class="icon-location"></i>
              Adresse
            </h3>
            
            <div class="form-group">
              <label for="adresse">Adresse *</label>
              <input 
                id="adresse"
                type="text" 
                formControlName="adresse"
                placeholder="Ex: 1 rue de Paris"
                [class.error]="clientForm.get('adresse')?.invalid && clientForm.get('adresse')?.touched"
              >
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="ville">Ville *</label>
                <input 
                  id="ville"
                  type="text" 
                  formControlName="ville"
                  placeholder="Ex: Paris"
                  [class.error]="clientForm.get('ville')?.invalid && clientForm.get('ville')?.touched"
                >
              </div>
              
              <div class="form-group">
                <label for="codePostal">Code postal *</label>
                <input 
                  id="codePostal"
                  type="text" 
                  formControlName="codePostal"
                  placeholder="Ex: 75001"
                  maxlength="5"
                  [class.error]="clientForm.get('codePostal')?.invalid && clientForm.get('codePostal')?.touched"
                >
              </div>
            </div>

            <div class="form-group">
              <label for="pays">Pays *</label>
              <select 
                id="pays"
                formControlName="pays"
                [class.error]="clientForm.get('pays')?.invalid && clientForm.get('pays')?.touched"
              >
                <option value="">Sélectionner un pays</option>
                <option value="France">France</option>
                <option value="Belgique">Belgique</option>
                <option value="Suisse">Suisse</option>
                <option value="Canada">Canada</option>
              </select>
            </div>
          </div>

          <!-- Contact -->
          <div class="form-section">
            <h3 class="section-title">
              <i class="icon-contact"></i>
              Contact principal
            </h3>
            
            <div class="form-group">
              <label for="contactNom">Nom du contact *</label>
              <input 
                id="contactNom"
                type="text" 
                formControlName="contactNom"
                placeholder="Ex: Jean Dupont"
                [class.error]="clientForm.get('contactNom')?.invalid && clientForm.get('contactNom')?.touched"
              >
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="contactEmail">Email *</label>
                <input 
                  id="contactEmail"
                  type="email" 
                  formControlName="contactEmail"
                  placeholder="contact@entreprise.com"
                  [class.error]="clientForm.get('contactEmail')?.invalid && clientForm.get('contactEmail')?.touched"
                >
                <span class="error-message" *ngIf="clientForm.get('contactEmail')?.invalid && clientForm.get('contactEmail')?.touched">
                  Email invalide
                </span>
              </div>
              
              <div class="form-group">
                <label for="contactTelephone">Téléphone *</label>
                <input 
                  id="contactTelephone"
                  type="tel" 
                  formControlName="contactTelephone"
                  placeholder="0123456789"
                  maxlength="10"
                  [class.error]="clientForm.get('contactTelephone')?.invalid && clientForm.get('contactTelephone')?.touched"
                >
              </div>
            </div>
          </div>
        </div>

        <div class="form-actions">
          <button type="button" class="btn-secondary" (click)="cancelForm()">
            Annuler
          </button>
          <button type="submit" class="btn-primary" [disabled]="!clientForm.valid">
            <i class="icon-save"></i>
            Ajouter le client
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Liste des clients -->
  <div class="clients-grid">
    <div class="client-card" *ngFor="let client of clients" (click)="showDetails(client)">
      <div class="card-header">
        <div class="company-info">
          <h3 class="company-name">{{ client.nomEntreprise }}</h3>
          <span class="sector-badge" [attr.data-sector]="client.secteurActivite">
            {{ client.secteurActivite }}
          </span>
        </div>
        <div class="card-menu">
          <button class="menu-btn" (click)="$event.stopPropagation()">⋯</button>
        </div>
      </div>

      <div class="card-body">
        <div class="contact-info">
          <div class="contact-item">
            <i class="icon-person"></i>
            <span>{{ client.contactNom }}</span>
          </div>
          <div class="contact-item">
            <i class="icon-email"></i>
            <span>{{ client.contactEmail }}</span>
          </div>
          <div class="contact-item">
            <i class="icon-phone"></i>
            <span>{{ client.contactTelephone }}</span>
          </div>
        </div>

        <div class="address-info">
          <div class="address-item">
            <i class="icon-location"></i>
            <span>{{ client.adresse }}, {{ client.ville }} {{ client.codePostal }}</span>
          </div>
        </div>

        <div class="siret-info">
          <span class="siret-label">SIRET:</span>
          <span class="siret-number">{{ client.siret }}</span>
        </div>
      </div>

      <div class="card-footer">
        <span class="client-id">#{{ client.id }}</span>
        <div class="card-actions">
          <button class="btn-spreadsheet" (click)="openSpreadsheet(client); $event.stopPropagation()">
            <i class="icon-spreadsheet"></i>
            Feuille de calcul
          </button>
          <button class="btn-details">Voir détails</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal de détails -->
  <div class="modal-overlay" *ngIf="selectedClient" (click)="closeDetails()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>{{ selectedClient.nomEntreprise }}</h2>
        <button class="close-btn" (click)="closeDetails()">×</button>
      </div>
      <div class="modal-body">
        <div class="detail-section">
          <h4>Informations de l'entreprise</h4>
          <p><strong>Secteur:</strong> {{ selectedClient.secteurActivite }}</p>
          <p><strong>SIRET:</strong> {{ selectedClient.siret }}</p>
        </div>
        <div class="detail-section">
          <h4>Adresse</h4>
          <p>{{ selectedClient.adresse }}</p>
          <p>{{ selectedClient.ville }} {{ selectedClient.codePostal }}</p>
          <p>{{ selectedClient.pays }}</p>
        </div>
        <div class="detail-section">
          <h4>Contact</h4>
          <p><strong>Nom:</strong> {{ selectedClient.contactNom }}</p>
          <p><strong>Email:</strong> {{ selectedClient.contactEmail }}</p>
          <p><strong>Téléphone:</strong> {{ selectedClient.contactTelephone }}</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Page Feuille de calcul -->
  <div class="spreadsheet-page" *ngIf="showSpreadsheet && selectedClientForSpreadsheet">
    <div class="spreadsheet-header">
      <div class="client-info">
        <button class="back-btn" (click)="closeSpreadsheet()">
          <i class="icon-arrow-left"></i>
          Retour
        </button>
        <div class="client-details">
          <h2>{{ selectedClientForSpreadsheet.nomEntreprise }}</h2>
          <p>Gestion des crédits et transactions</p>
        </div>
      </div>
      
      <div class="balance-summary">
        <div class="balance-card positive" *ngIf="getClientBalance() >= 0">
          <div class="balance-label">Solde créditeur</div>
          <div class="balance-amount">+{{ getClientBalance() | number:'1.2-2' }}€</div>
        </div>
        <div class="balance-card negative" *ngIf="getClientBalance() < 0">
          <div class="balance-label">Solde débiteur</div>
          <div class="balance-amount">{{ getClientBalance() | number:'1.2-2' }}€</div>
        </div>
      </div>
    </div>

    <!-- Formulaire d'ajout de transaction -->
    <div class="transaction-form-container">
      <div class="form-toggle">
        <button 
          class="toggle-btn" 
          [class.active]="showTransactionForm"
          (click)="showTransactionForm = !showTransactionForm"
        >
          <i class="icon-plus"></i>
          {{ showTransactionForm ? 'Masquer' : 'Nouvelle transaction' }}
        </button>
      </div>

      <div class="transaction-form" [class.show]="showTransactionForm">
        <form [formGroup]="transactionForm" (ngSubmit)="addTransaction()" class="form-grid-transaction">
          <div class="form-group">
            <label for="date">Date *</label>
            <input 
              id="date"
              type="date" 
              formControlName="date"
              [class.error]="transactionForm.get('date')?.invalid && transactionForm.get('date')?.touched"
            >
          </div>

          <div class="form-group">
            <label for="type">Type *</label>
            <select 
              id="type"
              formControlName="type"
              [class.error]="transactionForm.get('type')?.invalid && transactionForm.get('type')?.touched"
            >
              <option value="">Sélectionner un type</option>
              <option value="entree">Entrée d'argent (+)</option>
              <option value="sortie">Sortie d'argent (-)</option>
            </select>
          </div>

          <div class="form-group">
            <label for="montant">Montant *</label>
            <input 
              id="montant"
              type="number" 
              step="0.01"
              min="0"
              formControlName="montant"
              placeholder="0.00"
              [class.error]="transactionForm.get('montant')?.invalid && transactionForm.get('montant')?.touched"
            >
          </div>

          <div class="form-group">
            <label for="description">Description *</label>
            <input 
              id="description"
              type="text" 
              formControlName="description"
              placeholder="Ex: Paiement facture, Remboursement..."
              [class.error]="transactionForm.get('description')?.invalid && transactionForm.get('description')?.touched"
            >
          </div>

          <div class="form-group">
            <label for="categorie">Catégorie</label>
            <select 
              id="categorie"
              formControlName="categorie"
            >
              <option value="">Sélectionner une catégorie</option>
              <option value="facture">Facture</option>
              <option value="paiement">Paiement</option>
              <option value="remboursement">Remboursement</option>
              <option value="avance">Avance</option>
              <option value="penalite">Pénalité</option>
              <option value="bonus">Bonus</option>
              <option value="autre">Autre</option>
            </select>
          </div>

          <div class="form-group">
            <label for="reference">Référence</label>
            <input 
              id="reference"
              type="text" 
              formControlName="reference"
              placeholder="Ex: FAC-2024-001"
            >
          </div>

          <div class="form-actions-transaction">
            <button type="button" class="btn-secondary" (click)="resetTransactionForm()">
              Annuler
            </button>
            <button type="submit" class="btn-primary" [disabled]="!transactionForm.valid">
              <i class="icon-save"></i>
              Ajouter la transaction
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Tableau des transactions -->
    <div class="transactions-table-container">
      <div class="table-header">
        <h3>Historique des transactions</h3>
        <div class="table-filters">
          <select [(ngModel)]="filterType" class="filter-select">
            <option value="">Tous les types</option>
            <option value="entree">Entrées</option>
            <option value="sortie">Sorties</option>
          </select>
          <input 
            type="text" 
            [(ngModel)]="searchTerm" 
            placeholder="Rechercher..." 
            class="search-input"
          >
        </div>
      </div>

      <div class="table-responsive">
        <table class="transactions-table">
          <thead>
            <tr>
              <th>Date</th>
              <th>Type</th>
              <th>Description</th>
              <th>Catégorie</th>
              <th>Référence</th>
              <th>Montant</th>
              <th>Solde</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let transaction of getFilteredTransactions(); let i = index" 
                [class]="transaction.type">
              <td>{{ transaction.date | date:'dd/MM/yyyy' }}</td>
              <td>
                <span class="type-badge" [class]="transaction.type">
                  {{ transaction.type === 'entree' ? 'Entrée' : 'Sortie' }}
                </span>
              </td>
              <td>{{ transaction.description }}</td>
              <td>
                <span class="category-tag" *ngIf="transaction.categorie">
                  {{ transaction.categorie }}
                </span>
              </td>
              <td>{{ transaction.reference || '-' }}</td>
              <td class="montant" [class]="transaction.type">
                {{ transaction.type === 'entree' ? '+' : '-' }}{{ transaction.montant | number:'1.2-2' }}€
              </td>
              <td class="solde" [class.positive]="transaction.soldeApres >= 0" [class.negative]="transaction.soldeApres < 0">
                {{ transaction.soldeApres | number:'1.2-2' }}€
              </td>
              <td>
                <div class="action-buttons">
                  <button class="btn-edit" (click)="editTransaction(transaction)" title="Modifier">
                    <i class="icon-edit"></i>
                  </button>
                  <button class="btn-delete" (click)="deleteTransaction(transaction.id)" title="Supprimer">
                    <i class="icon-delete"></i>
                  </button>
                </div>
              </td>
            </tr>
          </tbody>
        </table>

        <div class="empty-state" *ngIf="getFilteredTransactions().length === 0">
          <div class="empty-icon">📊</div>
          <h4>Aucune transaction</h4>
          <p>Commencez par ajouter votre première transaction pour ce client.</p>
        </div>
      </div>
    </div>

    <!-- Statistiques -->
    <div class="statistics-section">
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-icon">💰</div>
          <div class="stat-content">
            <div class="stat-value">{{ getTotalEntrees() | number:'1.2-2' }}€</div>
            <div class="stat-label">Total des entrées</div>
          </div>
        </div>
        
        <div class="stat-card">
          <div class="stat-icon">💸</div>
          <div class="stat-content">
            <div class="stat-value">{{ getTotalSorties() | number:'1.2-2' }}€</div>
            <div class="stat-label">Total des sorties</div>
          </div>
        </div>
        
        <div class="stat-card">
          <div class="stat-icon">📈</div>
          <div class="stat-content">
            <div class="stat-value">{{ getTransactionCount() }}</div>
            <div class="stat-label">Nombre de transactions</div>
          </div>
        </div>
        
        <div class="stat-card">
          <div class="stat-icon">📅</div>
          <div class="stat-content">
            <div class="stat-value">{{ getLastTransactionDate() | date:'dd/MM/yyyy' }}</div>
            <div class="stat-label">Dernière transaction</div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>